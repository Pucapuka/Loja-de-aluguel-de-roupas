const sqlite3 = require('sqlite3').verbose();
const fs = require('fs');
const path = require('path');
const os = require('os');

// DETECTAR AMBIENTE: Docker ou Local?
const isDocker = process.env.DOCKER_ENV === 'true';

// Caminho do banco de dados
let dbPath;

if (isDocker) {
    // DOCKER: usar /data (volume persistente)
    dbPath = '/data/loja.db';
    console.log('ðŸ³ Ambiente Docker: Banco em /data/loja.db');
} else {
    // LOCAL: usar home do usuÃ¡rio
    dbPath = path.join(os.homedir(), '.loja-roupas', 'loja.db');
    console.log('ðŸ’» Ambiente Local: Banco em', dbPath);
}

const dbDir = path.dirname(dbPath);

// Garantir diretÃ³rio de dados
if (!fs.existsSync(dbDir)) {
    fs.mkdirSync(dbDir, { recursive: true });
    console.log(`ðŸ“ DiretÃ³rio de dados criado: ${dbDir}`);
}

// Conectar ao banco
const db = new sqlite3.Database(dbPath, (err) => {
    if (err) {
        console.error('âŒ Erro ao conectar com o SQLite:', err.message);
    } else {
        console.log('âœ… Banco SQLite ativo em:', dbPath);
        initializeDatabase();
    }
});

// Ativar foreign keys
db.run('PRAGMA foreign_keys = ON');

// InicializaÃ§Ã£o das tabelas (MANTENHA SEU CÃ“DIGO ORIGINAL AQUI)
function initializeDatabase() {
    db.serialize(() => {
        db.run(`CREATE TABLE IF NOT EXISTS produtos (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            codigo TEXT UNIQUE NOT NULL,
            nome TEXT NOT NULL,
            tamanho TEXT,
            cor TEXT,
            preco_aluguel REAL,
            estoque INTEGER DEFAULT 0
        )`);

        db.run(`CREATE TABLE IF NOT EXISTS clientes (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            nome TEXT NOT NULL,
            cpf TEXT UNIQUE,
            telefone TEXT,
            endereco TEXT,
            email TEXT,
            data_cadastro TEXT DEFAULT CURRENT_TIMESTAMP
        )`);

        db.run(`CREATE TABLE IF NOT EXISTS alugueis (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            cliente_id INTEGER NOT NULL,
            data_inicio TEXT,
            data_fim TEXT,
            valor_total REAL DEFAULT 0,
            status TEXT DEFAULT 'ativo',
            data_criacao TEXT DEFAULT CURRENT_TIMESTAMP,
            FOREIGN KEY (cliente_id) REFERENCES clientes(id)
        )`);

        db.run(`CREATE TABLE IF NOT EXISTS aluguel_itens (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            aluguel_id INTEGER NOT NULL,
            produto_id INTEGER NOT NULL,
            quantidade INTEGER NOT NULL DEFAULT 1,
            valor_unitario REAL NOT NULL,
            total_parcial REAL NOT NULL,
            FOREIGN KEY (aluguel_id) REFERENCES alugueis(id) ON DELETE CASCADE,
            FOREIGN KEY (produto_id) REFERENCES produtos(id)
        )`);

        db.run(`CREATE TABLE IF NOT EXISTS pagamentos (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            aluguel_id INTEGER NOT NULL,
            valor REAL NOT NULL,
            forma_pagamento TEXT NOT NULL,
            data_vencimento DATE,
            data_pagamento DATE,
            status TEXT DEFAULT 'pendente',
            observacao TEXT,
            FOREIGN KEY (aluguel_id) REFERENCES alugueis(id) ON DELETE CASCADE
        )`);

        console.log('âœ… Estrutura de tabelas verificada/criada');
        checkAndInsertSampleData();
    });
}

// InserÃ§Ã£o de dados iniciais (MANTENHA SEU CÃ“DIGO ORIGINAL)
function checkAndInsertSampleData() {
    db.get(`SELECT COUNT(*) AS count FROM produtos`, (err, row) => {
        if (err) return console.error('âŒ Erro ao verificar produtos:', err.message);

        if (row.count === 0) {
            console.log('ðŸ“ Banco vazio. Inserindo dados de exemplo...');
            insertSampleData();
        } else {
            console.log(`âœ… Banco jÃ¡ contÃ©m ${row.count} produtos`);
            showDataCounts();
        }
    });
}

function insertSampleData() {
    db.run(
        `INSERT OR IGNORE INTO clientes (nome, cpf, telefone, email, endereco) VALUES
        ('JoÃ£o Silva', '12345678901', '(11) 99999-9999', 'joao@email.com', 'Rua A, 123 - Centro'),
        ('Maria Santos', '98765432100', '(11) 88888-8888', 'maria@email.com', 'Av. B, 456 - Jardim'),
        ('Pedro Oliveira', '11122233344', '(11) 77777-7777', 'pedro@email.com', 'Travessa C, 789 - Vila Nova')`,
        function (err) {
            if (err) console.error('âŒ Erro ao inserir clientes:', err.message);
            else console.log(`âœ… ${this.changes} clientes inseridos`);
        }
    );

    db.run(
        `INSERT OR IGNORE INTO produtos (codigo, nome, tamanho, cor, preco_aluguel, estoque) VALUES
        ('P-001', 'Vestido Longo Elegante', 'M', 'Preto', 50.00, 5),
        ('P-002', 'Terno Social', 'G', 'Azul Marinho', 80.00, 3),
        ('P-003', 'Blazer Feminino', 'P', 'Branco', 40.00, 0),
        ('P-004', 'Vestido Curto Festa', 'P', 'Vermelho', 35.00, 2),
        ('P-005', 'Smoking', 'M', 'Preto', 100.00, 1),
        ('P-006', 'Saia Longa', 'M', 'Azul', 30.00, 4),
        ('P-007', 'CalÃ§a Social', 'G', 'Cinza', 45.00, 2),
        ('P-008', 'Camisa Social', 'M', 'Branco', 25.00, 6)`,
        function (err) {
            if (err) console.error('âŒ Erro ao inserir produtos:', err.message);
            else {
                console.log(`âœ… ${this.changes} produtos inseridos`);
                showDataCounts();
            }
        }
    );
}

function showDataCounts() {
    const tables = ['produtos', 'clientes', 'alugueis', 'aluguel_itens', 'pagamentos'];
    tables.forEach(table => {
        db.get(`SELECT COUNT(*) AS count FROM ${table}`, (err, row) => {
            if (!err) console.log(`ðŸ“Š ${row.count} registros em ${table}`);
        });
    });
}

module.exports = db;
